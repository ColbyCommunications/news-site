###
# Contains hooks that are fired when an environment is deployed. See https://docs.platform.sh/configuration/app/build.html#deploy-hook
###
# Ensures that if an error occurs in one of our hooks it will fail the build
set -e
################################
###          CORE           ###
###############################


################################
###        WORDPRESS        ###
###############################

# create a symlink to our actual file in the root of mu-plugins
./scripts/setup-mu-plugins.sh

# fix mu-plugin symlinks for irregular plugins
./scripts/symlink.sh /app/web/wp-content/mu-plugins/wordpress-seo/wp-seo.php /app/web/wp-content/mu-plugins/wp-seo.php
./scripts/symlink.sh /app/web/wp-content/mu-plugins/wp-search-with-algolia/algolia.php /app/web/wp-content/mu-plugins/algolia.php

# If we're on a MULTISITE and not on the master branch
if [ "$PLATFORM_BRANCH" != master ] && [ ! -z ${MULTISITE+x} ]; then
  php scripts/update-multisite-db.php
fi

./scripts/cleanup-dev-db.sh

#Import the base settings for the cache-control plugin
php scripts/wp-import-config.php


################################
###     Project Specific    ###
###############################
# Add any additional project specific deploy hooks you need in the environment after this line